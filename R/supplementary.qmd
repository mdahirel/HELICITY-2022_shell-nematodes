---
title: "supplementary"
author: "Maxime Dahirel"
format: html
editor_options: 
  chunk_output_type: console
---


```{r packages}
library(sf)
library(car)
library(emmeans)
library(glmmTMB)
library(DHARMa)
library(tidyverse)

library(here)
```

 

```{r}
nematodes <- read_csv(here("data","HELICITY22_nematodes.csv"))

points <- st_read(here("data","HELICITY22_sites_BELambert72_wGHSL.gpkg")) |> 
  mutate(x=st_coordinates(geom)[,1],
         y=st_coordinates(geom)[,2]) |> 
  mutate(
    SMOD_type =  case_when(SMOD ==30 ~ "3 - Urban Centre",
                      (SMOD >= 20 & SMOD < 30) ~ "2 - Intermediate",
                      (SMOD > 10 & SMOD < 20) ~ "1 - Rural",
                      SMOD == 10 ~ "0 - Water bodies",
                      T ~ NA_character_)
  )
```

```{r}
data <- nematodes |> 
  mutate(has.nematodes = Nematodes>0) |> 
  group_by(Population) |>
  summarise(
    N_nema = sum(has.nematodes, na.rm=TRUE),
    N = sum(!is.na(has.nematodes))
  ) |> 
  left_join(points) |> 
  st_as_sf()
```

# S1: correlations between urbanisation metrics //  SMOD matches the SPEEDY topology (to make better)

```{r}
SPEEDY_threshold <- tibble( ## from e.g. Piano et al papers
  ymin=c(0,0.05,0.15),
  ymax=c(0.03,0.1,1),
  SPEEDY_type=c("low","medium","high")
)


ggplot(points)+
  geom_hline(yintercept = c(0,0.03,0.05,0.1,0.15))+
  geom_boxplot(aes(SMOD_type,BUILT1000/(1000*1000),col=SMOD_type))+ 
  labs(x="Degree of Urbanisation (GHS-SMOD, 1km grid cell)", y = "Proportion built-up within 1km grid cell")+
  theme_bw()

```



# intensity (ish, number of nematodes in shells containing nematodes)

```{r}

infected <- nematodes |> 
  filter(Nematodes > 0) |> 
  left_join(points) |> 
  mutate(Nematodes_minus_1 = Nematodes - 1)  # so the test variable stays bounded at 0

mod=glmmTMB(Nematodes_minus_1 ~ SMOD_type + City + (1|Population),data=infected, family=poisson)
plot(simulateResiduals(mod))
Anova(mod)


preds_infected <- emmeans(mod,specs = ~ SMOD_type, type="response") |> 
  as_tibble()

ggplot(infected) + 
  geom_point(aes(SMOD_type,Nematodes),position = position_jitter(width=0.3,height=0),col="darkgrey") + 
  geom_pointrange(data = preds_infected, aes(x=SMOD_type,y=rate + 1,ymin=asymp.LCL + 1,ymax=asymp.UCL + 1),size=1,pch=21,fill="white") +
  labs(x="Urbanisation type (SMOD, 1km grid)", y = "Number of nematodes per shell containing nematodes")+
  scale_y_log10()+
  theme_bw()
```

