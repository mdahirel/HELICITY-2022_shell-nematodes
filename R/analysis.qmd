---
title: "analysis"
author: "Maxime Dahirel"
format: html
editor_options: 
  chunk_output_type: console
---


```{r packages}
library(sf)
library(DHARMa)
library(car)
library(emmeans)
library(ncf)  # for spline correlograms
library(lme4)
library(MuMIn)


library(tidyverse)

library(here)
```

 

```{r}
nematodes <- read_csv(here("data","HELICITY22_nematodes.csv"))

points <- st_read(here("data","HELICITY22_sites_BELambert72_wGHSL.gpkg")) |> 
  mutate(x=st_coordinates(geom)[,1],
         y=st_coordinates(geom)[,2]) |> 
  mutate(
    SMOD_type =  case_when(SMOD ==30 ~ "3 - Urban Centre",
                      (SMOD >= 20 & SMOD < 30) ~ "2 - Intermediate",
                      (SMOD > 10 & SMOD < 20) ~ "1 - Rural",
                      SMOD == 10 ~ "0 - Water bodies",
                      T ~ NA_character_)
  )
```

```{r}
data <- nematodes |> 
  mutate(has.nematodes = Nematodes>0) |> 
  group_by(Population) |>
  summarise(
    N_nema = sum(has.nematodes, na.rm=TRUE),
    N = sum(!is.na(has.nematodes))
  ) |> 
  left_join(points) |> 
  st_as_sf()
```


```{r}
## misc numbers for methods
dim(points)[1] # number of sites visited
dim(nematodes)[1] # number of snails
length(unique(nematodes$Population)) # number of sites with snails
sum(data$N) #number of snails scanned for nematodes (i.e. excluding missing snails)
dim(data)[1] # number of sites with snails, after accounting for lost snails

table(points$City)  # spread of visited sites between cities
table(data$City)    # spread of sites with Cepaea between cities

sum(data$N_nema)    # number of snails with nematodes
sum(nematodes$Nematodes,na.rm=TRUE)  # number of nematodes found across all shells

mean(points$N_collectors) ## mean number of collectors per site
range(points$N_collectors)
mean(points$Sampling_effort_minutes)  # effort in person-minutes
range(points$Sampling_effort_minutes)

nearest <- st_nearest_feature(points)
nearest_dist <- st_distance(points, points[nearest,], by_element=TRUE)

range(nearest_dist)
mean(nearest_dist)

nearest <- st_nearest_feature(data)
nearest_dist <- st_distance(data, data[nearest,], by_element=TRUE)

range(nearest_dist)
mean(nearest_dist)
```

```{r}
mod_built100 <- glm(cbind(N_nema,N-N_nema)~scale(BUILT100),data=data,family=binomial)
mod_built1000 <- glm(cbind(N_nema,N-N_nema)~scale(BUILT1000),data=data,family=binomial)
mod_pop100 <- glm(cbind(N_nema,N-N_nema)~scale(POP100),data=data,family=binomial)
mod_pop1000 <- glm(cbind(N_nema,N-N_nema)~scale(POP1000),data=data,family=binomial)

mod_SMOD <- glm(cbind(N_nema,N-N_nema)~SMOD_type,data=data,family=binomial)
```

## test for model assumption

```{r}
testDispersion(mod_SMOD)
testDispersion(mod_SMOD,type="PearsonChisq")
performance::check_overdispersion(mod_SMOD)

## you can test with all five models, similar behaviour:
## conflict between the simulation-based DHARMa and the traditional parametric test
## there are indication that maybe the traditional one is anticonservative because we have low min(Np, N(1-p))
## see https://github.com/florianhartig/DHARMa/issues/117 and link to ben bolker FAQ
## we are in such a case here:

tibble(
  Np = fitted(mod_SMOD)*data$N,
  N1minusp = (1-fitted(mod_SMOD))*data$N
) |> 
  rowwise() |> 
  mutate(min_of_Np_N1minusp=min(Np,N1minusp)) |> 
  ungroup() |> 
  ggplot()+
  geom_histogram(aes(min_of_Np_N1minusp))+
  geom_vline(xintercept = 5)
```



```{r}
mod_built100_OLRE <- glmer(cbind(N_nema,N-N_nema)~scale(BUILT100)+(1|Population),data=data,family=binomial)
mod_built1000_OLRE <- glmer(cbind(N_nema,N-N_nema)~scale(BUILT1000)+(1|Population),data=data,family=binomial)
mod_pop100_OLRE <- glmer(cbind(N_nema,N-N_nema)~scale(POP100)+(1|Population),data=data,family=binomial)
mod_pop1000_OLRE <- glmer(cbind(N_nema,N-N_nema)~scale(POP1000)+(1|Population),data=data,family=binomial)

mod_SMOD_OLRE <- glmer(cbind(N_nema,N-N_nema)~SMOD_type+(1|Population),data=data,family=binomial)
```

# model comparison

```{r}
model.sel(mod_built100,mod_built1000,mod_pop100,mod_pop1000,mod_SMOD,rank="AICc")

model.sel(mod_built100_OLRE,mod_built1000_OLRE,mod_pop100_OLRE,mod_pop1000_OLRE,mod_SMOD_OLRE,rank="AICc")
```

# autocorrelation check

```{r}
simres <- simulateResiduals(mod_SMOD_OLRE,n=1000)

plot(simres)

testSpatialAutocorrelation(simulationOutput = simres, 
                           x = data$x, y= data$y)


correlog <- spline.correlog (x = data$x/1000, y = data$y/1000,
                             z = residuals(mod_SMOD_OLRE, type = "pearson"))

plot(correlog) # no evidence of residual autocorrelation
```


# model exploration

```{r}
# binomial case

Anova(mod_SMOD)

contrast(emmeans(mod_SMOD,specs = ~ SMOD_type),method="pairwise")
preds <- emmeans(mod_SMOD,specs = ~ SMOD_type, type="response")|> 
  as_tibble() |> 
  mutate(type="no OLRE")
```

```{r}

# with OLRE case, used for plots

Anova(mod_SMOD_OLRE)

contrast(emmeans(mod_SMOD_OLRE,specs = ~ SMOD_type),method="pairwise")

preds_OLRE <- emmeans(mod_SMOD_OLRE,specs = ~ SMOD_type, type="response") |> 
  as_tibble() |> 
  mutate(type="with OLRE")
```

# plot

```{r}
ggplot(data) + 
  geom_point(aes(SMOD_type,N_nema/N,size=N),position = position_jitter(width=0.3,height=0),col="darkgrey") + 
  geom_pointrange(data = preds_OLRE, aes(x=SMOD_type,y=prob,ymin=asymp.LCL,ymax=asymp.UCL),size=1,pch=21,fill="white")+ 
  scale_size_area("Number of snails") + 
  labs(x="Degree of Urbanisation (GHS-SMOD, 1km grid cell)", y = "Proportion of shells with nematodes")+
  theme_bw()
```

```{r}

ggplot(data) + 
  geom_point(aes(SMOD_type,N_nema/N,size=N),position = position_jitter(width=0.3,height=0),col="darkgrey") + 
  geom_pointrange(data = rbind(preds,preds_OLRE), aes(x=SMOD_type,y=prob,ymin=asymp.LCL,ymax=asymp.UCL,col=type),size=1,pch=21,fill="white",position=position_dodge(width=0.2))+ 
  scale_size_area("Number of snails") + 
  labs(x="Degree of Urbanisation (GHS-SMOD, 1km grid cell)", y = "Proportion of shells with nematodes")+
  theme_bw()
```
